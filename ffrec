#!/bin/sh
# Record the screen.

# runtime files
lockdir=/tmp/ffrec$DISPLAY
pidfile=$lockdir/pid

# spawn ffmpeg processes
ffstart() {
	ffmpeg \
		-loglevel panic \
		-f x11grab \
		-s 1920x1080 \
		-i "$DISPLAY" \
		-f alsa \
		-i hw:0 \
		-r 25 \
		-c:v libx264 \
		-c:a flac \
		"$HOME/video/rec/$(date +'%d-%m-%y_%H:%M:%S').mkv" &
}

# wait for ffmpeg to terminate
ffwait() {
	# we use loop here beacause signals interrupt wait
	while ! wait; do
		:
	done
}

# kill ffmpeg process (on SIGTERM)
ffkill() {
	trap '' TERM
	kill "$!"
}

# do the recording
record() {
	ffstart
	trap ffkill TERM
	ffwait
}

# ignore sigterm for now
trap '' TERM

if mkdir "$lockdir" 2>/dev/null; then
	# recorder branch
	echo $$ >"$pidfile"
	case $(printf '%s\n' Yes No | dmenu -l 10 -p 'Start recording?') in
		Y*) record
	esac
	rm -r "$lockdir"
else
	# killer branch
	case $(printf '%s\n' Yes No | dmenu -l 10 -p 'Stop recording?') in
		Y*) pkill -F "$pidfile" 2>/dev/null ;;
	esac
fi
